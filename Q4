WITH Age_Category AS (
    SELECT
        CASE
            WHEN c.Age < 30 THEN 'Below 30'
            ELSE '30 and Above'
        END AS Age_Group,
        o.Item,
        COUNT(*) AS Purchase_Count,
        RANK() OVER (
            PARTITION BY
                CASE
                    WHEN c.Age < 30 THEN 'Below 30'
                    ELSE '30 and Above'
                END
            ORDER BY COUNT(*) DESC
        ) AS rnk
    FROM Customer c
    JOIN "Order" o
        ON c.Customer_ID = o.Customer_ID
    GROUP BY
        CASE
            WHEN c.Age < 30 THEN 'Below 30'
            ELSE '30 and Above'
        END,
        o.Item
)
SELECT
    Age_Group,
    Item AS Most_Purchased_Product,
    Purchase_Count
FROM Age_Category
WHERE rnk = 1;
